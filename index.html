<!DOCTYPE html>
<html>
<body>
<a href="http://soundcloud.com" ><img src="powered_by_black-ee7e351d64511ecea75c6c17ca30064f.png" /></a> <br/>
<canvas id="theCanvas" width="1024" height="256"></canvas> <br/>
<button id="oscilloscopeButton" type="button">Oscilloscope</button>
<button id="frequencyBarsButton" type="button">Frequency bars</button> <br/>
<button id="playButton" type="button" ><h1>&#9658; Play Track!</h1></button> <br/>
<span id="currentTime">00:00:00</span>
<input id="slider" type="range" value="0" />
<span id="totalTime">00:00:00</span> <br/>
<input id="trackUrlSearch" type="url" placeholder="URL of SoundCloud track" /> <button id="findButton">Find</button> <br/> 
<label>Artist: 
  <a id="artistUrl">
    <span id="artistName"></span><br/>
    <img id="artistAvatar" />
  </a>
</label>
<br/>  
<label>Track:
  <a id="trackUrl">
    <span id="trackName"></span><br/>
    <img id="trackArt" />
  </a>
</label>

<script>
  (function() {
    var AudioContext;
    var audio;
    var audioContext;
    var source;
    var analyser;
      
    var canvas = document.querySelector('#theCanvas');
    var canvasContext = canvas.getContext("2d");    
    var dataArray;
    var analyserMethod = "getByteTimeDomainData";
    var slider = document.getElementById("slider");
    var streamUrl;
    var isIdle = true;
    
    var canvasWidth = canvas.width;
    var canvasHeight = canvas.height;
    
    function initAudio() {
      AudioContext = window.AudioContext || window.webkitAudioContext;
      audio = new Audio();
      audioContext = new AudioContext();
      source = audioContext.createMediaElementSource(audio);
      source.connect(audioContext.destination);
      analyser = audioContext.createAnalyser();            
      source.connect(analyser);
    };
    
    function get(url, callback) {
      var request = new XMLHttpRequest();
      request.onreadystatechange = function() { 
        if (request.readyState === 4 && request.status === 200) {
          callback(request.responseText);
        }
      }
  
      request.open("GET", url, true);            
      request.send(null);
    }
  
    var clientParameter = "client_id=88eadb2708d8b015244b19bf35e65513"
    
    // Basing everything on the track's permalink URL. That is what the user knows.
    // Makes it possible to add a text box for pasting any track URL.
    var trackPermalinkUrl = "http://soundcloud.com/the-outsider/through-time-space-mix";
   
    function findTrack() {
      get("http://api.soundcloud.com/resolve.json?url=" +  trackPermalinkUrl + "&" + clientParameter,
        function (response) {
          var trackInfo = JSON.parse(response);

          slider.max = trackInfo.duration / 1000;
          document.getElementById("totalTime").innerHTML = millisecondsToHuman(trackInfo.duration);
          document.getElementById("artistUrl").href = trackInfo.user.permalink_url;
          document.getElementById("artistAvatar").src = trackInfo.user.avatar_url;
          document.getElementById("artistName").innerHTML = trackInfo.user.username;

          document.getElementById("trackUrl").href = trackInfo.permalink_url;
          if(trackInfo.artwork_url) {
            document.getElementById("trackArt").src = trackInfo.artwork_url;
          } else {
            document.getElementById("trackArt").src = "";
          }
          document.getElementById("trackName").innerHTML = trackInfo.title;
          streamUrl = trackInfo.stream_url + "?" + clientParameter;
        }
      );
    };

    function startIdleAnimation() {
      // Makes the sine wave height increase and decrease
      var amplitude = 100;
      // Makes the sine wave move to the left
      var phase = 0;
      var isIncreasing = false;

      function drawIdleAnimation() {
        canvasContext.clearRect(0, 0, canvasWidth, canvasHeight);
        if(isIdle) {
          requestAnimationFrame(drawIdleAnimation);
        }
        canvasContext.beginPath();
        for(var x = 0; x < canvasWidth; x++){
          canvasContext.lineTo(x, Math.sin((x+phase)/50)*amplitude + 120);
        }
        canvasContext.stroke();
        phase++;
        if(amplitude > 100) {
          isIncreasing = false;
        } else if(amplitude < 1) {
          isIncreasing = true;
        }
        
        if(isIncreasing) {
          amplitude++;
        } else {
          amplitude--;
        }
      }
      
      drawIdleAnimation();
    }
    
    function startDrawing() {
      // Stop drawing idle animation
      isIdle = false;
      analyser.fftSize = 2048;
      var bufferLength = analyser.frequencyBinCount;
      console.log(bufferLength);
      dataArray = new Uint8Array(bufferLength);

      function drawAgain() {
        canvasContext.clearRect(0, 0, canvasWidth, canvasHeight);
        requestAnimationFrame(drawAgain);
        
        analyser[analyserMethod](dataArray);

        for(var i = 0; i < bufferLength; i++){
          canvasContext.beginPath();
          canvasContext.moveTo(i, 255);
          canvasContext.lineTo(i, 255 - dataArray[i]);
          canvasContext.closePath();
          canvasContext.stroke();
        }
      }
      
      drawAgain();
    }
      
    function startButton_Clicked() {
      audio.src = streamUrl;
      audio.play();
      slider.value = 0;

      setInterval(function () {
        slider.value = audio.currentTime; 
      }, 3000); 
      // Using three seconds so the user can change the value of
      // the slider. Too short interval will cause the automatic
      // updating to steal the control from the user.
      
      var currentTime = document.getElementById("currentTime");
      setInterval(function () {
        currentTime.innerHTML = millisecondsToHuman(audio.currentTime * 1000); 
      }, 1000);
      
      startDrawing();
    }
    
    function jumpTo(here) {
      if (!audio.readyState) return false;
      audio.currentTime = here;
    };
    
    slider.addEventListener("change", function () {
      jumpTo(this.value);
    });
    
    function millisecondsToHuman(milliseconds) {
      var date = new Date(null);
      date.setMilliseconds(milliseconds);
      return date.toISOString().substr(11, 8);
    };

    document.getElementById("playButton").addEventListener('click', startButton_Clicked);
    
    document.getElementById("oscilloscopeButton").addEventListener('click', function(){
      analyserMethod = "getByteTimeDomainData";
    });
    
    document.getElementById("frequencyBarsButton").addEventListener('click', function(){
      analyserMethod = "getByteFrequencyData";
    });
    
    document.getElementById("findButton").addEventListener('click', function(){
      trackPermalinkUrl = document.getElementById("trackUrlSearch").value;
      findTrack();
    });
    
    startIdleAnimation();
    findTrack();
    initAudio();
  
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-42639091-3', 'auto');
    ga('send', 'pageview');

})();
  
</script>
  
</body>
</html>
