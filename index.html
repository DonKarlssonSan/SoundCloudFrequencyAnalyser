<html>
<body>
<canvas id="theCanvas" width="1024" height="256"></canvas> <br/>
<button id="playButton" type="button">Play</button> <br/>
Current time: <div id="currentTime">0</div>
<input id="slider" type="range"></input> <br/>
<button id="oscilloscopeButton" type="button">Oscilloscope</button> <br/>
<button id="frequencyBarsButton" type="button">Frequency bars</button> <br/>
<label>Artist: 
  <a id="artistUrl">
    <div id="artistName"></div>
    <img id="artistAvatar"></img>
  </a>
</label>
<br/>  
<label>Track:
  <a id="trackUrl">
    <div id="trackName"></div>
    <img id="trackArt"></img>
  </a>
</label>

<script>
  (function() {
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audio = new Audio();
    var mediaStreamSource;
    var analyser;
    var canvas = document.querySelector('#theCanvas');
    var canvasContext = canvas.getContext("2d");    
    var dataArray;
    var analyserMethod = "getByteTimeDomainData";
    var slider = document.getElementById("slider");
    var streamUrl;
    
    canvasWidth = canvas.width;
    canvasHeight = canvas.height;
    
    var get = function(url, callback) {
      var request = new XMLHttpRequest();
      request.onreadystatechange = function() { 
        if (request.readyState === 4 && request.status === 200) {
          callback(request.responseText);
        }
      }
  
      request.open("GET", url, true);            
      request.send(null);
    }
  
    var clientParameter = "client_id=88eadb2708d8b015244b19bf35e65513"
    var trackPermalinkUrl = "http://soundcloud.com/the-outsider/through-time-space-mix";
   
    get("http://api.soundcloud.com/resolve.json?url=" +  trackPermalinkUrl + "&" + clientParameter,
      function (response) {
        var trackInfo = JSON.parse(response);
        
        document.getElementById("artistUrl").href = trackInfo.user.permalink_url;
        document.getElementById("artistAvatar").src = trackInfo.user.avatar_url;
        document.getElementById("artistName").innerHTML = trackInfo.user.username;
      
        document.getElementById("trackUrl").href = trackInfo.permalink_url;
        document.getElementById("trackArt").src = trackInfo.artwork_url;
        document.getElementById("trackName").innerHTML = trackInfo.title;
        streamUrl = trackInfo.stream_url + "?" + clientParameter;
      }
    );

    function startDrawing() {
      
      analyser.fftSize = 2048;
      var bufferLength = analyser.frequencyBinCount;
      console.log(bufferLength);
      dataArray = new Uint8Array(bufferLength);

      function drawAgain() {
        canvasContext.clearRect(0, 0, canvasWidth, canvasWidth);
        requestAnimationFrame(drawAgain);
        
        analyser[analyserMethod](dataArray);

        for(var i = 0; i < bufferLength; i++){
          canvasContext.beginPath();
          canvasContext.moveTo(i, 255);
          canvasContext.lineTo(i, 255 - dataArray[i]);
          canvasContext.closePath();
          canvasContext.stroke();
        }
      }
      
      drawAgain();
    }
      
    function startButton_Clicked() {
      this.disabled = true;
      var audioContext = new AudioContext();
      var source;

      audio.src = streamUrl;
      source = audioContext.createMediaElementSource(audio);
      source.connect(audioContext.destination);
      
      analyser = audioContext.createAnalyser();            
      source.connect(analyser);
      
      audio.play();

      setInterval(function () {
        slider.value = audio.currentTime; 
      }, 3000);
      
      var currentTime = document.getElementById("currentTime");
      setInterval(function () {
        currentTime.innerHTML = audio.currentTime; 
      }, 800);
      
      startDrawing();
    }
    
    function jumpTo(here) {
      if (!audio.readyState) return false;
      audio.currentTime = here;
    };
    slider.addEventListener("change", function () {
      jumpTo(this.value);
    });
    slider.max = 3617;
    slider.value = 0;

    document.getElementById("playButton").addEventListener('click', startButton_Clicked);
    
    document.getElementById("oscilloscopeButton").addEventListener('click', function(){
      analyserMethod = "getByteTimeDomainData";
    });
    
    document.getElementById("frequencyBarsButton").addEventListener('click', function(){
      analyserMethod = "getByteFrequencyData";
    });
})();
  
</script>
  
</body>
</html>
