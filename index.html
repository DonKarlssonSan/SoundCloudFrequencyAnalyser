<html>
<body>
<canvas id="theCanvas" width="1024" height="256"></canvas> <br/>
<button id="playButton" type="button">Play</button> <br/>
Current time: <div id="currentTime">0</div>
<input id="slider" type="range"> <br/>
<button id="oscilloscopeButton" type="button">Oscilloscope</button> <br/>
<button id="frequencyBarsButton" type="button">Frequency bars</button> <br/>
<script>
  (function() {
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var mediaStreamSource;
    var analyser;
    var canvas = document.querySelector('#theCanvas');
    var canvasContext = canvas.getContext("2d");    
    var dataArray;
    var analyserMethod = "getByteTimeDomainData";
    
    canvasWidth = canvas.width;
    canvasHeight = canvas.height;

    function startDrawing() {
      
      analyser.fftSize = 2048;
      var bufferLength = analyser.frequencyBinCount;
      console.log(bufferLength);
      dataArray = new Uint8Array(bufferLength);

      function drawAgain() {
        canvasContext.clearRect(0, 0, canvasWidth, canvasWidth);
        requestAnimationFrame(drawAgain);
        
        analyser[analyserMethod](dataArray);

        for(var i = 0; i < bufferLength; i++){
          canvasContext.beginPath();
          canvasContext.moveTo(i, 255);
          canvasContext.lineTo(i, 255 - dataArray[i]);
          canvasContext.closePath();
          canvasContext.stroke();
        }
      }
      
      drawAgain();
    }
      
    function startButton_Clicked() {
      this.disabled = true;
      var audioContext = new AudioContext();

      var audio = new Audio();
      var source;
      // `stream_url` you'd get from 
      // requesting http://api.soundcloud.com/tracks/177482784.json
      var url = 'http://api.soundcloud.com/tracks/177482784/stream?client_id=88eadb2708d8b015244b19bf35e65513';
      
      audio.src = url;
      source = audioContext.createMediaElementSource(audio);
      source.connect(audioContext.destination);
      
      analyser = audioContext.createAnalyser();            
      source.connect(analyser);
      
      audio.play();
      
      startDrawing();
    }
    
    function jumpTo(here) {
      if (!audio.readyState) return false;
      audio.currentTime = here;
    };
    
    document.getElementById("playButton").addEventListener('click', startButton_Clicked);
    
    document.getElementById("oscilloscopeButton").addEventListener('click', function(){
      analyserMethod = "getByteTimeDomainData";
    });
    
    document.getElementById("frequencyBarsButton").addEventListener('click', function(){
      analyserMethod = "getByteFrequencyData";
    });
    
    var slider = document.getElementById("slider");
    slider.addEventListener("onchange", function () {
      jumpTo(this.value);
    });
    slider.max = 3617;
    setInterval(function () {
      slider.value = audio.currentTime; 
    }, 3000);
    
    var currentTime = document.getElementById("currentTime");
    setInterval(function () {
      currentTime.innerHTML = audio.currentTime; 
    }, 800);

})();
  
</script>
  
</body>
</html>
